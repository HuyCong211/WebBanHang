@model PagedList.IPagedList<DoAnChuyenNganh.Models.EF.BinhLuan>
@using PagedList.Mvc;
@{
    ViewBag.Title = "Quản lý bình luận";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

@section naviheader
{
    <!-- Left navbar links -->
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
            <a href="/admin/home" class="nav-link">Trang chủ</a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
            <a href="/admin/binhluan" class="nav-link">Quản lý bình luận</a>
        </li>
    </ul>
}

<!-- Content Header (Page header) -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Quản lý bình luận</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/admin/home/">Trang chủ</a></li>
                    <li class="breadcrumb-item active">Quản lý bình luận</li>
                </ol>
            </div>
        </div>
    </div><!-- /.container-fluid -->
</section>

<!-- Main content -->
<section class="content">

    <!-- Default box -->
    <div class="card">

        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="card-title">Danh sách bình luận</h3>
        </div>
        <div class="card-header d-flex justify-content-between align-items-center">
            <!-- Form tìm kiếm bên trái -->
            <form method="get" action="@Url.Action("Index")" class="form-inline">
                <input type="text" name="tim" value="@ViewBag.CurrentFilter"
                       class="form-control mr-2" style="width:350px;" placeholder="Nhập tên sản phẩm..." />
                <button type="submit" class="btn btn-primary">Tìm kiếm</button>
            </form>

        </div>
        <div class="card-body">

            <table class="table table-bordered table-hover" id="tblBinhLuan">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Sản phẩm</th>
                        <th>Nội dung</th>
                        <th>Sao</th>
                        <th>Người bình luận</th>
                        <th>Ngày tạo</th>
                        <th>Trạng thái</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                @{
                    // Lấy vị trí bắt đầu của STT cho trang hiện tại
                    int stt = (Model.PageNumber - 1) * Model.PageSize + 1;
                }
                <tbody>
                    @{
                        int i = 1;
                        foreach (var item in Model)
                        {
                                        <tr data-id="@item.BinhLuanId">
                                            <td>@i</td>
                                            <td>@(item.SanPham?.TenSanPham ?? "Không xác định")</td>
                                            <td>@item.NoiDung</td>
                                            <td>@item.Sao</td>
                                            <td>@(item.User != null ? (string.IsNullOrEmpty(item.User.Fullname) ? item.User.UserName : item.User.Fullname) : "Ẩn danh")</td>
                                            <td>@(item.NgayTao.HasValue ? item.NgayTao.Value.ToString("dd/MM/yyyy HH:mm") : "")</td>
                                            <td>
                                                <span class="badge @(item.TrangThai == true ? "bg-success" : "bg-secondary")">
                                                    @(item.TrangThai == true ? "Hiển thị" : "Ẩn")
                                                </span>
                                            </td>
                                            <td>
                                                @if (item.TrangThai == true)
                                                {
                                                    <button class="btn btn-warning btn-sm btn-an">Ẩn</button>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-success btn-sm btn-duyet">Duyệt</button>
                                                }
                                                <button class="btn btn-danger btn-sm btn-xoa">Xóa</button>
                                            </td>
                                        </tr>
                            i++;
                        }
                    }
                </tbody>
            </table>
            <br />
            <div class="row">
                <div class="col-12 text-center" style="margin-bottom:8px; font-weight:bold;">
                    Trang @(Model.PageNumber) / @(Model.PageCount)
                    @*<br />*@
                    @Html.PagedListPager(Model, page => Url.Action("Index", new { page, tim = Request.QueryString["tim"] }))
                </div>
            </div>


        </div>
    </div>
</section>


@section scripts{
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function () {
            // Xử lý Ẩn
            $('#tblBinhLuan').on('click', '.btn-an', function () {
                const row = $(this).closest('tr');
                const id = row.data('id');
                $.post('@Url.Action("An", "BinhLuan", new { area = "Admin" })', { id: id }, function (res) {
                    if (res.success) {
                        Swal.fire('Thành công', res.message, 'success');
                        row.find('.badge').removeClass('bg-success').addClass('bg-secondary').text('Ẩn');
                        row.find('.btn-an').replaceWith('<button class="btn btn-success btn-sm btn-duyet">Duyệt</button>');
                    } else {
                        Swal.fire('Lỗi', res.message, 'error');
                    }
                });
            });

            // Xử lý Duyệt
            $('#tblBinhLuan').on('click', '.btn-duyet', function () {
                const row = $(this).closest('tr');
                const id = row.data('id');
                $.post('@Url.Action("Duyet", "BinhLuan", new { area = "Admin" })', { id: id }, function (res) {
                    if (res.success) {
                        Swal.fire('Thành công', res.message, 'success');
                        row.find('.badge').removeClass('bg-secondary').addClass('bg-success').text('Hiển thị');
                        row.find('.btn-duyet').replaceWith('<button class="btn btn-warning btn-sm btn-an">Ẩn</button>');
                    } else {
                        Swal.fire('Lỗi', res.message, 'error');
                    }
                });
            });

            // Xử lý Xóa
            $('#tblBinhLuan').on('click', '.btn-xoa', function () {
                const row = $(this).closest('tr');
                const id = row.data('id');
                Swal.fire({
                    title: 'Xác nhận xóa?',
                    text: "Hành động này không thể hoàn tác!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Xóa',
                    cancelButtonText: 'Hủy',
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.post('@Url.Action("Delete", "BinhLuan", new { area = "Admin" })', { id: id }, function (res) {
                            if (res.success) {
                                row.fadeOut(500, function () { $(this).remove(); });
                                Swal.fire('Đã xóa!', res.message, 'success');
                            } else {
                                Swal.fire('Lỗi', res.message, 'error');
                            }
                        });
                    }
                });
            });
        });
    </script>
}
